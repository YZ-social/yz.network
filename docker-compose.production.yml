# Production deployment for Oracle Cloud (or any server)
# Bootstrap + Bridge Nodes + Dashboard

services:
  # Enhanced Bootstrap Server (Public-facing)
  bootstrap:
    image: itsmeront/yz-dht-node:latest
    container_name: yz-bootstrap-server
    command: node src/bridge/start-enhanced-bootstrap.js -createNewDHT -openNetwork
    ports:
      - "8080:8080"  # Public bootstrap/WebSocket server
    environment:
      - WEBSOCKET_PORT=8080
      - WEBSOCKET_HOST=0.0.0.0
      - CREATE_NEW_DHT=true
      - OPEN_NETWORK=true
      - BRIDGE_AUTH=${BRIDGE_AUTH:-default-bridge-auth-key}
      - BRIDGE_NODE_1=bridge-node-1:8083
      - BRIDGE_NODE_2=bridge-node-2:8084
      - METRICS_PORT=9090
    networks:
      - yz-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Bridge Node 1 (Internal Docker + WSS accessible via /bridge1)
  bridge-node-1:
    image: itsmeront/yz-dht-node:latest
    container_name: yz-bridge-node-1
    command: node src/bridge/start-single-bridge-node.js 8083
    ports:
      - "8083:8083"
      - "9083:9090"
    environment:
      - BRIDGE_PORT=8083
      - WEBSOCKET_HOST=0.0.0.0
      - EXTERNAL_ADDRESS=wss://imeyouwe.com/bridge1     # All connections via nginx
      - BOOTSTRAP_URL=ws://bootstrap:8080
      - NODE_NAME=bridge-node-1
      - METRICS_PORT=9090
      - BRIDGE_AUTH=${BRIDGE_AUTH:-default-bridge-auth-key}
    extra_hosts:
      - "imeyouwe.com:172.18.0.3"  # Route to nginx container for internal Docker connections
    networks:
      - yz-network
    restart: unless-stopped
    depends_on:
      bootstrap:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:9090/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Bridge Node 2 (Internal Docker + WSS accessible via /bridge2)
  bridge-node-2:
    image: itsmeront/yz-dht-node:latest
    container_name: yz-bridge-node-2
    command: node src/bridge/start-single-bridge-node.js 8084
    ports:
      - "8084:8084"
      - "9084:9090"
    environment:
      - BRIDGE_PORT=8084
      - WEBSOCKET_HOST=0.0.0.0
      - EXTERNAL_ADDRESS=wss://imeyouwe.com/bridge2     # All connections via nginx
      - BOOTSTRAP_URL=ws://bootstrap:8080
      - NODE_NAME=bridge-node-2
      - METRICS_PORT=9090
      - BRIDGE_AUTH=${BRIDGE_AUTH:-default-bridge-auth-key}
    extra_hosts:
      - "imeyouwe.com:172.18.0.3"  # Route to nginx container for internal Docker connections
    networks:
      - yz-network
    restart: unless-stopped
    depends_on:
      bootstrap:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:9090/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Genesis Node - First active DHT participant (Internal Docker + WSS accessible via /genesis)
  genesis-node:
    image: itsmeront/yz-dht-node:latest
    container_name: yz-genesis-node
    command: node src/docker/start-dht-node.js
    ports:
      - "8085:8085"  # WebSocket port
      - "9095:9090"  # Metrics port
    environment:
      - BOOTSTRAP_URL=ws://bootstrap:8080
      - WEBSOCKET_PORT=8085
      - WEBSOCKET_HOST=0.0.0.0
      - EXTERNAL_ADDRESS=wss://imeyouwe.com/genesis     # All connections via nginx
      - METRICS_PORT=9090
      - NODE_NAME=genesis-node
      - OPEN_NETWORK=true
    extra_hosts:
      - "imeyouwe.com:172.18.0.3"  # Route to nginx container for internal Docker connections
    networks:
      - yz-network
    restart: unless-stopped
    depends_on:
      bootstrap:
        condition: service_healthy
      bridge-node-1:
        condition: service_healthy
      bridge-node-2:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:9090/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Monitoring Dashboard
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    image: itsmeront/yz-dashboard:latest
    container_name: yz-dashboard
    ports:
      - "3001:3000"
    environment:
      - BOOTSTRAP_URL=http://bootstrap:8080
      - BRIDGE_NODE_1_URL=http://bridge-node-1:9090
      - BRIDGE_NODE_2_URL=http://bridge-node-2:9090
      - METRICS_SCRAPE_INTERVAL=10000
    volumes:
      # Mount Docker socket for container discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - yz-network
    restart: unless-stopped
    depends_on:
      - bootstrap
      - bridge-node-1
      - bridge-node-2
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M

  # HTTPS Web Server (Browser Client)
  webserver:
    image: nginx:alpine
    container_name: yz-webserver
    ports:
      - "80:80"    # HTTP (redirects to HTTPS)
      - "443:443"  # HTTPS
    volumes:
      - ./dist:/usr/share/nginx/html:ro
      - ./nginx-main.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      # Mount Let's Encrypt certificates
      - /etc/letsencrypt:/etc/letsencrypt:ro
    networks:
      - yz-network
    restart: unless-stopped
    depends_on:
      - bootstrap
    # Increase file descriptor limits to prevent "No file descriptors available" errors
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "https://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M

networks:
  yz-network:
    driver: bridge

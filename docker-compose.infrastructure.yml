version: '3.8'

# Infrastructure Services - PRIMARY SERVER ONLY
# Run this FIRST on your main server to set up bootstrap and bridge nodes
# Usage: docker-compose -f docker-compose.infrastructure.yml up -d

services:
  # Bootstrap Server - Entry point for DHT network
  # This should be publicly accessible on your server
  bootstrap:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yz-bootstrap
    command: node src/bridge/start-enhanced-bootstrap.js -createNewDHT -openNetwork
    ports:
      - "${BOOTSTRAP_PORT:-8080}:8080"  # Public WebSocket endpoint
      - "9091:9090"  # Metrics endpoint
    environment:
      - BOOTSTRAP_MODE=true
      - CREATE_NEW_DHT=true
      - OPEN_NETWORK=true
      - MAX_PEERS=10000
      - METRICS_PORT=9090
      - BRIDGE_NODE_1=bridge-node-1:8083
      - BRIDGE_NODE_2=bridge-node-2:8084
      - BRIDGE_AUTH=${BRIDGE_AUTH:-default-bridge-auth-key}
    networks:
      - dht-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - bridge-node-1
      - bridge-node-2

  # Bridge Nodes - Internal DHT observers for reconnection services
  # These nodes help coordinate peer connections in open network mode
  bridge-node-1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yz-bridge-1
    command: node src/bridge/start-single-bridge-node.js 8083
    ports:
      - "8083:8083"  # WebSocket server for bridge coordination
      - "9083:9090"  # Metrics endpoint
    environment:
      - BRIDGE_PORT=8083
      - BRIDGE_AUTH=${BRIDGE_AUTH:-default-bridge-auth-key}
      - BOOTSTRAP_URL=ws://bootstrap:8080
      - METRICS_PORT=9090
      - PUBLIC_ADDRESS=bridge-node-1:8083
    networks:
      - dht-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  bridge-node-2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yz-bridge-2
    command: node src/bridge/start-single-bridge-node.js 8084
    ports:
      - "8084:8084"  # WebSocket server for bridge coordination
      - "9084:9090"  # Metrics endpoint
    environment:
      - BRIDGE_PORT=8084
      - BRIDGE_AUTH=${BRIDGE_AUTH:-default-bridge-auth-key}
      - BOOTSTRAP_URL=ws://bootstrap:8080
      - METRICS_PORT=9090
      - PUBLIC_ADDRESS=bridge-node-2:8084
    networks:
      - dht-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Monitoring Dashboard - Web UI to monitor the DHT network
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: yz-dashboard
    ports:
      - "${DASHBOARD_PORT:-3001}:3000"  # Public dashboard interface
    environment:
      - BOOTSTRAP_URL=http://bootstrap:9090
      - METRICS_SCRAPE_INTERVAL=10000  # Scrape metrics every 10 seconds
    volumes:
      # Mount Docker socket for container discovery (Windows/WSL2 compatible)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - dht-network
    depends_on:
      - bootstrap
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  dht-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
